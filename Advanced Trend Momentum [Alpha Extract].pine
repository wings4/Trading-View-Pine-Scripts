//@version=6
indicator("Advanced Trend Momentum [Alpha Extract]", shorttitle="ATM Pro", overlay=false)

// ═══════════════════════════════════════════════════════════════════════════════════
// INPUT PARAMETERS
// ═══════════════════════════════════════════════════════════════════════════════════

// Trend Analysis Settings
trendGroup = "═══ TREND ANALYSIS ═══"
emaFastLen = input.int(12, "Fast EMA Length", minval=1, group=trendGroup)
emaSlowLen = input.int(26, "Slow EMA Length", minval=1, group=trendGroup)
trendStrength = input.int(14, "Trend Strength Period", minval=1, group=trendGroup)

// Support & Resistance Settings
srGroup = "═══ SUPPORT & RESISTANCE ═══"
pivotLength = input.int(10, "Pivot Length", minval=2, group=srGroup)
maxLevels = input.int(3, "Max S/R Levels", minval=1, maxval=5, group=srGroup)
showSRLevels = input.bool(true, "Show S/R Levels", group=srGroup)

// Momentum Settings
momentumGroup = "═══ MOMENTUM ═══"
rsiLength = input.int(14, "RSI Length", minval=1, group=momentumGroup)
oversoldLevel = input.int(30, "Oversold Level", minval=1, maxval=49, group=momentumGroup)
overboughtLevel = input.int(70, "Overbought Level", minval=51, maxval=99, group=momentumGroup)

// Visual Settings
visualGroup = "═══ VISUAL SETTINGS ═══"
show_colored_candles = input.bool(true, "Show Colored Candles", group=visualGroup)
bullColor = input.color(#00D4AA, "Bullish Color", group=visualGroup)
bearColor = input.color(#FF6B6B, "Bearish Color", group=visualGroup)
neutralColor = input.color(#95A5A6, "Neutral Color", group=visualGroup)
transparency = input.int(80, "Fill Transparency", minval=0, maxval=100, group=visualGroup)

// ═══════════════════════════════════════════════════════════════════════════════════
// CALCULATIONS
// ═══════════════════════════════════════════════════════════════════════════════════

// EMAs for trend analysis
emaFast = ta.ema(close, emaFastLen)
emaSlow = ta.ema(close, emaSlowLen)

// Trend direction and strength
trendDirection = emaFast > emaSlow ? 1 : -1
trendStrengthValue = math.abs(emaFast - emaSlow) / ta.atr(trendStrength) * 100

// RSI for momentum
rsi = ta.rsi(close, rsiLength)
rsiOverbought = rsi > overboughtLevel
rsiOversold = rsi < oversoldLevel

// Advanced momentum calculation
momentumValue = ta.change(close, 5) / ta.atr(10) * 100

// Support and Resistance levels using pivot points
pivotHigh = ta.pivothigh(high, pivotLength, pivotLength)
pivotLow = ta.pivotlow(low, pivotLength, pivotLength)

// Store recent pivot levels
var float[] resistanceLevels = array.new<float>()
var float[] supportLevels = array.new<float>()

if not na(pivotHigh)
    array.unshift(resistanceLevels, pivotHigh)
    if array.size(resistanceLevels) > maxLevels
        array.pop(resistanceLevels)

if not na(pivotLow)
    array.unshift(supportLevels, pivotLow)
    if array.size(supportLevels) > maxLevels
        array.pop(supportLevels)

// ═══════════════════════════════════════════════════════════════════════════════════
// VISUAL ELEMENTS
// ═══════════════════════════════════════════════════════════════════════════════════
// ═══════════════════════════════════════════════════════════════════════════════════
// RSI VISUAL ENHANCEMENTS
// ═══════════════════════════════════════════════════════════════════════════════════

// Plot RSI with enhanced visuals
plotRSI = plot(rsi, 'Relative Strength Index', color=#95A5A6, linewidth=1)
plotRSI2 = plot(rsi*0.97, 'Relative Strength Index', color=#95A5A6, linewidth=1, display = display.pane) 
fill(plotRSI,plotRSI2 , color = color.new(#95A5A6,80))

// Overbought and Oversold levels with better styling
overboughtline = hline(overboughtLevel, 'RSI Overbought', color=color.new(bearColor, 60), linewidth=1, linestyle=hline.style_dashed)
overboughtline2 = hline(overboughtLevel*1.02, 'RSI Overbought', color=color.new(bearColor, 60), linewidth=1, linestyle=hline.style_dashed)

overboughtline2p = plot(overboughtLevel*1.02, 'RSI Overbought', color=color.new(bearColor, 60), linewidth=1,display = display.none)
rsibc = #ffffff00
if rsi*0.97 > overboughtLevel*1.02  
    rsibc := color.new(bearColor,80)
if rsi*0.97 < overboughtLevel*1.02  
    rsibc := #ffffff00    

rsibc2 = #ffffff00
if rsi > oversoldLevel*0.95 
    rsibc2 := #ffffff00
if rsi < oversoldLevel*0.95 
    rsibc2 := color.new(bullColor,80)

fill(plotRSI2,overboughtline2p,color = rsibc)
fill(overboughtline,overboughtline2 , color = color.new(bearColor,80))
oversoldline = hline(oversoldLevel, 'RSI Oversold', color=color.new(bullColor, 60), linewidth=1, linestyle=hline.style_dashed)
oversoldline2 = hline(oversoldLevel*0.95, 'RSI Oversold', color=color.new(bullColor, 60), linewidth=1, linestyle=hline.style_dashed)

oversoldline2p = plot(oversoldLevel*0.95, 'RSI Oversold', color=color.new(bullColor, 60), linewidth=1,display = display.none)
fill(plotRSI,oversoldline2p,color = rsibc2)
fill(oversoldline,oversoldline2 , color = color.new(bullColor,80))

// Midline for reference
hline(50, 'RSI Midline', color=color.new(neutralColor, 50), linewidth=1, linestyle=hline.style_dotted)
m1 = hline(48, 'RSI Midline', color=color.new(neutralColor, 70), linewidth=1, linestyle=hline.style_dotted)
m2 = hline(52, 'RSI Midline', color=color.new(neutralColor, 70), linewidth=1, linestyle=hline.style_dotted)
fill(m1,m2,color = color.new(neutralColor,80))

// Plot EMAs with dynamic colors
emaFastColor = trendDirection > 0 ? bullColor : bearColor
emaSlowColor = trendDirection > 0 ? color.new(bullColor, 40) : color.new(bearColor, 40)

plotEmaFast = plot(emaFast, "Fast EMA", color=emaFastColor, linewidth=2,force_overlay = true)
plotEmaSlow = plot(emaSlow, "Slow EMA", color=emaSlowColor, linewidth=2,force_overlay = true)

// Trend fill between EMAs
fillColor = trendDirection > 0 ? 
     color.new(bullColor, transparency) : 
     color.new(bearColor, transparency)


fill(plotEmaFast, plotEmaSlow, color=fillColor, title="Trend Fill")

// Support and Resistance levels
if showSRLevels and barstate.islast
    if array.size(resistanceLevels) > 0
        for i = 0 to math.min(array.size(resistanceLevels) - 1, maxLevels - 1)
            if i < array.size(resistanceLevels)
                level = array.get(resistanceLevels, i)
                line.new(bar_index - 100, level, bar_index, level, 
                         color=color.new(bearColor, 30), style=line.style_dashed, width=1, extend=extend.right,force_overlay = true)
    
    // Plot support levels  
    if array.size(supportLevels) > 0
        for i = 0 to math.min(array.size(supportLevels) - 1, maxLevels - 1)
            if i < array.size(supportLevels)
                level = array.get(supportLevels, i)
                line.new(bar_index - 100, level, bar_index, level, 
                         color=color.new(bullColor, 30), style=line.style_dashed, width=1, extend=extend.right,force_overlay = true)

// Momentum-based bar coloring
barColor = if show_colored_candles
    if rsiOverbought and momentumValue < 0
        bearColor
    else if rsiOversold and momentumValue > 0
        bullColor
    else if trendDirection > 0 and momentumValue > 0
        bullColor
    else if trendDirection < 0 and momentumValue < 0
        bearColor
    else
        neutralColor
else
    na

plotcandle(open, high, low, close, title="Trend Strength Candles", 
     color=barColor, wickcolor=barColor, bordercolor=barColor, 
     force_overlay=true, display=show_colored_candles ? display.pane : display.none)

// ═══════════════════════════════════════════════════════════════════════════════════
// SIGNALS AND ALERTS
// ═══════════════════════════════════════════════════════════════════════════════════

// Trend change signals
trendChange = ta.change(trendDirection)
bullishSignal = trendChange > 0 and trendStrengthValue > 1
bearishSignal = trendChange < 0 and trendStrengthValue > 1

// Plot signals

// Momentum divergence signals
bullishDivergence = rsiOversold and momentumValue > momentumValue[1] and close < close[1]
bearishDivergence = rsiOverbought and momentumValue < momentumValue[1] and close > close[1]

plotshape(bullishDivergence, "Bullish Divergence", shape.diamond, location.belowbar, 
          color=color.new(bullColor, 30), size=size.tiny,force_overlay = true)
plotshape(bearishDivergence, "Bearish Divergence", shape.diamond, location.abovebar, 
          color=color.new(bearColor, 30), size=size.tiny,force_overlay = true)

// ═══════════════════════════════════════════════════════════════════════════════════
// TABLE DISPLAY
// ═══════════════════════════════════════════════════════════════════════════════════

// Create info table
if barstate.islast
    var infoTable = table.new(position.top_right, 2, 5, bgcolor=color.rgb(0, 0, 0), 
                               border_width=1, border_color=color.rgb(255, 255, 255))
    
    // Table headers and data
    table.cell(infoTable, 0, 0, "Metric", text_color=color.rgb(255, 255, 255), text_size=size.normal, bgcolor=color.new(color.gray, 80))
    table.cell(infoTable, 1, 0, "Value", text_color=color.rgb(255, 255, 255), text_size=size.normal, bgcolor=color.new(color.gray, 80))
    
    // Trend direction
    trendText = trendDirection > 0 ? "BULLISH" : "BEARISH"
    trendTextColor = trendDirection > 0 ? bullColor : bearColor
    table.cell(infoTable, 0, 1, "Trend", text_color=color.rgb(255, 255, 255), text_size=size.normal)
    table.cell(infoTable, 1, 1, trendText, text_color=trendTextColor, text_size=size.normal)
    
    // Trend strength
    strengthText = str.tostring(math.round(trendStrengthValue, 2)) + "%"
    table.cell(infoTable, 0, 2, "Strength", text_color=color.rgb(255, 255, 255), text_size=size.normal)
    table.cell(infoTable, 1, 2, strengthText, text_color=color.rgb(255, 255, 255), text_size=size.normal)
    
    // RSI
    rsiText = str.tostring(math.round(rsi, 1))
    rsiColor = rsiOverbought ? bearColor : rsiOversold ? bullColor : color.rgb(255, 255, 255)
    table.cell(infoTable, 0, 3, "RSI", text_color=color.rgb(255, 255, 255), text_size=size.normal)
    table.cell(infoTable, 1, 3, rsiText, text_color=rsiColor, text_size=size.normal)
    
    // Momentum
    momentumText = str.tostring(math.round(momentumValue, 1))
    momentumColor = momentumValue > 0 ? bullColor : bearColor
    table.cell(infoTable, 0, 4, "Momentum", text_color=color.rgb(255, 255, 255), text_size=size.normal)
    table.cell(infoTable, 1, 4, momentumText, text_color=momentumColor, text_size=size.normal)

// ═══════════════════════════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════════════════════════

// Alert conditions
alertcondition(bullishSignal, title="Bullish Trend Change", 
               message="{{ticker}} - Bullish trend detected! Fast EMA crossed above Slow EMA with strong momentum.")
alertcondition(bearishSignal, title="Bearish Trend Change", 
               message="{{ticker}} - Bearish trend detected! Fast EMA crossed below Slow EMA with strong momentum.")
alertcondition(bullishDivergence, title="Bullish Divergence", 
               message="{{ticker}} - Potential bullish divergence detected in oversold conditions.")
alertcondition(bearishDivergence, title="Bearish Divergence", 
               message="{{ticker}} - Potential bearish divergence detected in overbought conditions.")